{
  "problem_title": "Travel Expense Calculation System - Part 2: Multi-Currency Support",
  "part_number": 2,
  "builds_on": "Part 1",
  "difficulty": "medium",
  "problem_understanding": {
    "what_changes": "Part 2 extends the expense system to handle international travel where employees submit expenses in local currencies (EUR, GBP, JPY). The system must convert all amounts to USD before applying reimbursement policies, while storing the original amount and exchange rate for audit purposes.",
    "new_requirements": [
      "Support setting exchange rates for multiple currencies",
      "Accept expenses in any supported currency",
      "Convert to USD at expense creation time (not query time)",
      "Store both original and USD amounts for audit trail",
      "Maintain precision during currency conversion"
    ],
    "new_constraints": [
      "Exchange rates change daily - must capture rate at submission time",
      "Currency conversion introduces rounding issues - use Decimal for precision",
      "All reimbursement calculations performed in USD",
      "Unknown currency should raise error"
    ],
    "key_insight": "Convert to USD IMMEDIATELY when expense is created and store the exchange rate used. This ensures consistent calculations even if rates change later, and provides an audit trail. Apply reimbursement policies AFTER conversion to USD."
  },
  "visual_explanation": {
    "before_after": "```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    PART 1 vs PART 2 COMPARISON                          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                         \u2502\n\u2502  PART 1: Single Currency                                                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502   $500 USD   \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u25b6 \u2502  Policy Engine  \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u25b6 \u2502 Reimburse $X \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                         \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n\u2502                                                                         \u2502\n\u2502  PART 2: Multi-Currency (NEW!)                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502  \u2502   \u20ac180 EUR   \u2502 \u2500\u25b6 \u2502 Currency      \u2502 \u2500\u25b6 \u2502  $198 USD       \u2502           \u2502\n\u2502  \u2502   \u00a350 GBP    \u2502    \u2502 Converter     \u2502    \u2502  $63.50 USD     \u2502           \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502                      \u2502  \u2502EUR: 1.10\u2502  \u2502             \u2502                    \u2502\n\u2502                      \u2502  \u2502GBP: 1.27\u2502  \u2502             \u25bc                    \u2502\n\u2502                      \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502                      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502  Policy Engine  \u2502           \u2502\n\u2502                                           \u2502 (Same as Part 1)\u2502           \u2502\n\u2502                                           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2502                                                    \u2502                    \u2502\n\u2502                                                    \u25bc                    \u2502\n\u2502                                           \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510           \u2502\n\u2502                                           \u2502 Reimburse $X.XX \u2502           \u2502\n\u2502                                           \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```",
    "algorithm_flow": "```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     MULTI-CURRENCY PROCESSING FLOW                         \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                            \u2502\n\u2502  Step 1: SET EXCHANGE RATES                                                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                \u2502\n\u2502  \u2502  setExchangeRate(\"EUR\", 1.10)          \u2502                                \u2502\n\u2502  \u2502  setExchangeRate(\"GBP\", 1.27)          \u2502                                \u2502\n\u2502  \u2502                                        \u2502                                \u2502\n\u2502  \u2502  rates = { \"USD\": 1.0,                 \u2502                                \u2502\n\u2502  \u2502            \"EUR\": 1.10,  \u25c0\u2500\u2500 NEW       \u2502                                \u2502\n\u2502  \u2502            \"GBP\": 1.27 } \u25c0\u2500\u2500 NEW       \u2502                                \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                \u2502\n\u2502                                                                            \u2502\n\u2502  Step 2: ADD EXPENSE WITH CURRENCY                                         \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u2502\n\u2502  \u2502  addExpense(\"emp001\", \"HOTEL\", 180, \"EUR\", date, {nights: 2})  \u2502        \u2502\n\u2502  \u2502                                                                \u2502        \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                       \u2502        \u2502\n\u2502  \u2502  \u2502 1. Lookup rate      \u2502  rates[\"EUR\"] = 1.10                  \u2502        \u2502\n\u2502  \u2502  \u2502 2. Convert to USD   \u2502  \u20ac180 \u00d7 1.10 = $198                   \u2502        \u2502\n\u2502  \u2502  \u2502 3. Store BOTH       \u2502  original: \u20ac180, usd: $198            \u2502        \u2502\n\u2502  \u2502  \u2502 4. Capture rate     \u2502  exchange_rate: 1.10 (FROZEN!)        \u2502        \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                       \u2502        \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2502\n\u2502                                                                            \u2502\n\u2502  Step 3: CALCULATE REIMBURSEMENT                                           \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u2502\n\u2502  \u2502  For each expense:                                             \u2502        \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502        \u2502\n\u2502  \u2502  \u2502  Hotel: $198/night (already in USD!)                    \u2502   \u2502        \u2502\n\u2502  \u2502  \u2502         min($198, $200) \u00d7 2 nights = $396               \u2502   \u2502        \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502        \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502        \u2502\n\u2502  \u2502  \u2502  Transport: \u00a350 \u00d7 1.27 = $63.50 (already converted!)    \u2502   \u2502        \u2502\n\u2502  \u2502  \u2502            100% = $63.50                                \u2502   \u2502        \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502        \u2502\n\u2502  \u2502                                                                \u2502        \u2502\n\u2502  \u2502  TOTAL: $396.00 + $63.50 = $459.50                             \u2502        \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2502\n\u2502                                                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```"
  },
  "approaches": [
    {
      "name": "Naive Extension - Convert at Query Time",
      "description": "Store expenses in original currency and convert to USD when calculating reimbursement. Uses the current exchange rate at query time.",
      "time_complexity": "O(n) per calculation",
      "space_complexity": "O(n) for expenses",
      "why_not_optimal": "CRITICAL FLAW: If exchange rates change between expense submission and reimbursement calculation, the calculated amount changes! This breaks financial accuracy. An expense submitted at \u20ac100 when EUR=1.10 should always be $110, even if EUR later becomes 1.20. Also violates audit requirements - you can't recreate historical calculations."
    },
    {
      "name": "Optimal Approach - Convert at Creation Time",
      "description": "Convert to USD immediately when expense is created. Store original amount, USD amount, and the exchange rate used. Reimbursement policies always work with pre-converted USD amounts.",
      "time_complexity": "O(1) for addExpense, O(n) for calculateReimbursement",
      "space_complexity": "O(n) for expenses with additional currency metadata",
      "key_insight": "Freeze the exchange rate at submission time. The Expense object becomes immutable in terms of its USD value, regardless of future rate changes. This provides consistency, auditability, and matches real-world financial systems."
    }
  ],
  "optimal_solution": {
    "explanation_md": "## Optimal Solution: Immediate Conversion with Rate Capture\n\n### Core Design Principle\nThe key insight is that **exchange rates are temporal** - they have meaning only at a specific point in time. When an employee submits an expense, the relevant rate is the one at submission time, not the rate when accounting processes it days later.\n\n### Architecture Changes from Part 1\n\n**1. New CurrencyConverter Service Class**\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502       CurrencyConverter             \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 - _rates: Dict[str, Decimal]        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 + set_rate(currency, rate)          \u2502\n\u2502 + convert_to_usd(amount, currency)  \u2502\n\u2502 + get_rate(currency)                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\nSingle Responsibility: Only handles currency conversion logic.\n\n**2. Enhanced Expense Object**\nNow stores:\n- `original_amount`: The amount in original currency\n- `original_currency`: Currency code (EUR, GBP, etc.)\n- `usd_amount`: Converted amount in USD (**immutable after creation**)\n- `exchange_rate`: The rate used for conversion (**captured at creation**)\n\n**3. Processing Flow**\n1. **setExchangeRate()**: Updates the rate dictionary - O(1)\n2. **addExpense()**: Converts immediately using current rate, stores both amounts - O(1)\n3. **calculateReimbursement()**: Uses pre-converted USD amounts with policies - O(n)\n\n### Why Use Decimal?\n```python\n# Float precision issue:\n>>> 0.1 + 0.2\n0.30000000000000004\n\n# Decimal precision:\n>>> Decimal('0.1') + Decimal('0.2')\nDecimal('0.3')\n```\nFinancial calculations **require** Decimal to avoid accumulated rounding errors.\n\n### Key Implementation Details\n- **Rate Lookup**: O(1) using HashMap\n- **Conversion**: `amount \u00d7 rate` using Decimal arithmetic\n- **Policy Application**: Unchanged from Part 1, just uses `usd_amount`",
    "data_structures": [
      {
        "structure": "HashMap<String, Decimal>",
        "purpose": "Store exchange rates with O(1) lookup by currency code"
      },
      {
        "structure": "Enhanced Expense class",
        "purpose": "Store original currency, USD amount, and frozen exchange rate for audit trail"
      },
      {
        "structure": "CurrencyConverter (new class)",
        "purpose": "Encapsulate currency conversion logic following Single Responsibility Principle"
      }
    ],
    "algorithm_steps": [
      "Step 1: Initialize CurrencyConverter with USD rate of 1.0 as base",
      "Step 2: setExchangeRate() stores rate in HashMap - O(1)",
      "Step 3: addExpense() looks up current rate for given currency",
      "Step 4: Convert amount to USD: usd_amount = original_amount \u00d7 rate",
      "Step 5: Create Expense with both original and USD amounts, capture exchange rate",
      "Step 6: Store Expense and add to employee's expense list",
      "Step 7: calculateReimbursement() iterates expenses using usd_amount for policy calculations",
      "Step 8: Sum all reimbursements and round to 2 decimal places"
    ]
  },
  "solution_python_lines": [
    "\"\"\"",
    "Travel Expense Management System - Part 2: Multi-Currency Support",
    "",
    "This module extends the expense system to handle international currencies.",
    "Key features:",
    "- Exchange rate management with real-time updates",
    "- Immediate conversion to USD at expense creation",
    "- Audit trail with original amounts and rates",
    "- Precision handling using Decimal arithmetic",
    "\"\"\"",
    "",
    "from decimal import Decimal, ROUND_HALF_UP",
    "from typing import Dict, Any, List, Optional",
    "from abc import ABC, abstractmethod",
    "from enum import Enum",
    "from datetime import datetime",
    "",
    "",
    "class ExpenseType(Enum):",
    "    \"\"\"Enumeration of supported expense categories.\"\"\"",
    "    FLIGHT = \"FLIGHT\"",
    "    HOTEL = \"HOTEL\"",
    "    MEALS = \"MEALS\"",
    "    TRANSPORT = \"TRANSPORT\"",
    "",
    "",
    "class CurrencyConverter:",
    "    \"\"\"",
    "    Service class for currency conversion operations.",
    "    ",
    "    Maintains exchange rates and provides conversion to USD.",
    "    Rates are stored as Decimal for precision in financial calculations.",
    "    ",
    "    Attributes:",
    "        _rates: Dictionary mapping currency codes to USD conversion rates",
    "    \"\"\"",
    "    ",
    "    def __init__(self):",
    "        \"\"\"Initialize with USD as base currency (rate = 1.0).\"\"\"",
    "        self._rates: Dict[str, Decimal] = {\"USD\": Decimal(\"1.0\")}",
    "    ",
    "    def set_rate(self, currency: str, rate_to_usd: float) -> None:",
    "        \"\"\"",
    "        Set or update the exchange rate for a currency.",
    "        ",
    "        Args:",
    "            currency: ISO currency code (e.g., 'EUR', 'GBP')",
    "            rate_to_usd: How many USD equals 1 unit of currency",
    "        \"\"\"",
    "        self._rates[currency.upper()] = Decimal(str(rate_to_usd))",
    "    ",
    "    def convert_to_usd(self, amount: float, currency: str) -> Decimal:",
    "        \"\"\"",
    "        Convert an amount from the given currency to USD.",
    "        ",
    "        Args:",
    "            amount: The amount in original currency",
    "            currency: The currency code",
    "        ",
    "        Returns:",
    "            The equivalent amount in USD as Decimal",
    "        ",
    "        Raises:",
    "            ValueError: If currency is not supported",
    "        \"\"\"",
    "        currency = currency.upper()",
    "        if currency not in self._rates:",
    "            raise ValueError(f\"Unknown currency: {currency}\")",
    "        return Decimal(str(amount)) * self._rates[currency]",
    "    ",
    "    def get_rate(self, currency: str) -> Optional[Decimal]:",
    "        \"\"\"Get the current exchange rate for a currency.\"\"\"",
    "        return self._rates.get(currency.upper())",
    "",
    "",
    "class Expense:",
    "    \"\"\"",
    "    Represents a travel expense with multi-currency support.",
    "    ",
    "    Stores both original currency amount and USD conversion for audit.",
    "    The exchange rate is captured at creation time and frozen.",
    "    ",
    "    Attributes:",
    "        expense_id: Unique identifier for this expense",
    "        employee_id: ID of employee who submitted the expense",
    "        expense_type: Category of expense (FLIGHT, HOTEL, etc.)",
    "        original_amount: Amount in original currency",
    "        original_currency: Currency code of original amount",
    "        usd_amount: Converted amount in USD (immutable)",
    "        exchange_rate: Rate used for conversion (frozen at creation)",
    "        date: Date of expense in YYYY-MM-DD format",
    "        details: Additional metadata (nights, days, etc.)",
    "    \"\"\"",
    "    ",
    "    def __init__(",
    "        self,",
    "        expense_id: str,",
    "        employee_id: str,",
    "        expense_type: ExpenseType,",
    "        original_amount: Decimal,",
    "        original_currency: str,",
    "        usd_amount: Decimal,",
    "        exchange_rate: Decimal,",
    "        date: str,",
    "        details: Dict[str, Any]",
    "    ):",
    "        self.expense_id = expense_id",
    "        self.employee_id = employee_id",
    "        self.expense_type = expense_type",
    "        self.original_amount = original_amount",
    "        self.original_currency = original_currency",
    "        self.usd_amount = usd_amount",
    "        self.exchange_rate = exchange_rate",
    "        self.date = date",
    "        self.details = details",
    "",
    "",
    "# ============================================================",
    "# REIMBURSEMENT POLICIES (Strategy Pattern)",
    "# ============================================================",
    "",
    "class ReimbursementPolicy(ABC):",
    "    \"\"\"Abstract base class for expense reimbursement policies.\"\"\"",
    "    ",
    "    @abstractmethod",
    "    def calculate(self, expense: Expense) -> Decimal:",
    "        \"\"\"",
    "        Calculate the reimbursable amount for an expense.",
    "        ",
    "        Args:",
    "            expense: The expense to calculate reimbursement for",
    "        ",
    "        Returns:",
    "            The reimbursable amount in USD",
    "        \"\"\"",
    "        pass",
    "",
    "",
    "class FlightPolicy(ReimbursementPolicy):",
    "    \"\"\"Flight: 100% reimbursed up to $1000 limit.\"\"\"",
    "    ",
    "    LIMIT = Decimal(\"1000\")",
    "    ",
    "    def calculate(self, expense: Expense) -> Decimal:",
    "        return min(expense.usd_amount, self.LIMIT)",
    "",
    "",
    "class HotelPolicy(ReimbursementPolicy):",
    "    \"\"\"Hotel: 100% reimbursed up to $200 per night.\"\"\"",
    "    ",
    "    NIGHTLY_LIMIT = Decimal(\"200\")",
    "    ",
    "    def calculate(self, expense: Expense) -> Decimal:",
    "        nights = Decimal(str(expense.details.get(\"nights\", 1)))",
    "        # usd_amount is the per-night rate in USD",
    "        capped_per_night = min(expense.usd_amount, self.NIGHTLY_LIMIT)",
    "        return capped_per_night * nights",
    "",
    "",
    "class MealsPolicy(ReimbursementPolicy):",
    "    \"\"\"Meals: 50% reimbursed up to $50 per day.\"\"\"",
    "    ",
    "    DAILY_LIMIT = Decimal(\"50\")",
    "    REIMBURSEMENT_RATE = Decimal(\"0.5\")",
    "    ",
    "    def calculate(self, expense: Expense) -> Decimal:",
    "        days = Decimal(str(expense.details.get(\"days\", 1)))",
    "        # Apply 50% rate first, then cap",
    "        half_per_day = expense.usd_amount * self.REIMBURSEMENT_RATE",
    "        capped_per_day = min(half_per_day, self.DAILY_LIMIT)",
    "        return capped_per_day * days",
    "",
    "",
    "class TransportPolicy(ReimbursementPolicy):",
    "    \"\"\"Transport: 100% reimbursed with no limit.\"\"\"",
    "    ",
    "    def calculate(self, expense: Expense) -> Decimal:",
    "        return expense.usd_amount",
    "",
    "",
    "class PolicyFactory:",
    "    \"\"\"Factory for creating reimbursement policies (Factory Pattern).\"\"\"",
    "    ",
    "    _POLICIES = {",
    "        ExpenseType.FLIGHT: FlightPolicy,",
    "        ExpenseType.HOTEL: HotelPolicy,",
    "        ExpenseType.MEALS: MealsPolicy,",
    "        ExpenseType.TRANSPORT: TransportPolicy,",
    "    }",
    "    ",
    "    @classmethod",
    "    def get_policy(cls, expense_type: ExpenseType) -> ReimbursementPolicy:",
    "        \"\"\"Get the appropriate policy for an expense type.\"\"\"",
    "        policy_class = cls._POLICIES.get(expense_type)",
    "        if not policy_class:",
    "            raise ValueError(f\"No policy for expense type: {expense_type}\")",
    "        return policy_class()",
    "",
    "",
    "# ============================================================",
    "# MAIN EXPENSE MANAGER",
    "# ============================================================",
    "",
    "class ExpenseManager:",
    "    \"\"\"",
    "    Travel expense management system with multi-currency support.",
    "    ",
    "    Handles expense submission, currency conversion, and reimbursement",
    "    calculation according to company policies.",
    "    ",
    "    Features:",
    "        - Multi-currency expense submission",
    "        - Real-time exchange rate updates",
    "        - Policy-based reimbursement calculation",
    "        - Full audit trail with original amounts",
    "    ",
    "    Example:",
    "        >>> manager = ExpenseManager()",
    "        >>> manager.set_exchange_rate(\"EUR\", 1.10)",
    "        >>> manager.add_expense(\"emp001\", \"HOTEL\", 180, \"EUR\", \"2024-03-15\", {\"nights\": 2})",
    "        'exp_1'",
    "        >>> manager.calculate_reimbursement(\"emp001\")",
    "        396.0",
    "    \"\"\"",
    "    ",
    "    def __init__(self):",
    "        \"\"\"Initialize the expense manager with empty state.\"\"\"",
    "        self._expenses: Dict[str, Expense] = {}",
    "        self._employee_expenses: Dict[str, List[str]] = {}",
    "        self._currency_converter = CurrencyConverter()",
    "        self._expense_counter = 0",
    "    ",
    "    def set_exchange_rate(self, currency: str, rate_to_usd: float) -> None:",
    "        \"\"\"",
    "        Set or update the exchange rate for a currency.",
    "        ",
    "        The rate represents how many USD equals 1 unit of the currency.",
    "        For example, rate_to_usd=1.10 for EUR means 1 EUR = 1.10 USD.",
    "        ",
    "        Args:",
    "            currency: ISO currency code (e.g., 'EUR', 'GBP', 'JPY')",
    "            rate_to_usd: Conversion rate to USD",
    "        \"\"\"",
    "        self._currency_converter.set_rate(currency, rate_to_usd)",
    "    ",
    "    def add_expense(",
    "        self,",
    "        employee_id: str,",
    "        expense_type: str,",
    "        amount: float,",
    "        currency: str = \"USD\",",
    "        date: str = None,",
    "        details: Dict[str, Any] = None",
    "    ) -> str:",
    "        \"\"\"",
    "        Add a new expense with multi-currency support.",
    "        ",
    "        The amount is converted to USD immediately using the current",
    "        exchange rate. Both original and USD amounts are stored.",
    "        ",
    "        Args:",
    "            employee_id: Unique identifier for the employee",
    "            expense_type: Type of expense (FLIGHT, HOTEL, MEALS, TRANSPORT)",
    "            amount: Expense amount in original currency",
    "                   (per-night for hotels, per-day for meals)",
    "            currency: Currency code (default: USD)",
    "            date: Date of expense in YYYY-MM-DD format",
    "            details: Additional info (nights for hotel, days for meals)",
    "        ",
    "        Returns:",
    "            Unique expense ID (e.g., 'exp_1')",
    "        ",
    "        Raises:",
    "            ValueError: If currency is not supported",
    "            KeyError: If expense_type is invalid",
    "        \"\"\"",
    "        # Generate unique ID",
    "        self._expense_counter += 1",
    "        expense_id = f\"exp_{self._expense_counter}\"",
    "        ",
    "        # Default values",
    "        if details is None:",
    "            details = {}",
    "        if date is None:",
    "            date = datetime.now().strftime(\"%Y-%m-%d\")",
    "        ",
    "        # CRITICAL: Convert to USD immediately and capture the rate",
    "        usd_amount = self._currency_converter.convert_to_usd(amount, currency)",
    "        exchange_rate = self._currency_converter.get_rate(currency)",
    "        ",
    "        # Create expense with full currency information",
    "        expense = Expense(",
    "            expense_id=expense_id,",
    "            employee_id=employee_id,",
    "            expense_type=ExpenseType[expense_type.upper()],",
    "            original_amount=Decimal(str(amount)),",
    "            original_currency=currency.upper(),",
    "            usd_amount=usd_amount,",
    "            exchange_rate=exchange_rate,",
    "            date=date,",
    "            details=details",
    "        )",
    "        ",
    "        # Store expense",
    "        self._expenses[expense_id] = expense",
    "        ",
    "        # Track expenses by employee",
    "        if employee_id not in self._employee_expenses:",
    "            self._employee_expenses[employee_id] = []",
    "        self._employee_expenses[employee_id].append(expense_id)",
    "        ",
    "        return expense_id",
    "    ",
    "    def calculate_reimbursement(self, employee_id: str) -> float:",
    "        \"\"\"",
    "        Calculate total reimbursement for an employee.",
    "        ",
    "        Applies company reimbursement policies to all expenses",
    "        and returns the sum. All calculations use pre-converted USD.",
    "        ",
    "        Args:",
    "            employee_id: The employee to calculate reimbursement for",
    "        ",
    "        Returns:",
    "            Total reimbursable amount in USD, rounded to 2 decimal places",
    "        \"\"\"",
    "        if employee_id not in self._employee_expenses:",
    "            return 0.0",
    "        ",
    "        total = Decimal(\"0\")",
    "        ",
    "        for expense_id in self._employee_expenses[employee_id]:",
    "            expense = self._expenses[expense_id]",
    "            policy = PolicyFactory.get_policy(expense.expense_type)",
    "            reimbursement = policy.calculate(expense)",
    "            total += reimbursement",
    "        ",
    "        # Round to 2 decimal places for currency",
    "        return float(total.quantize(Decimal(\"0.01\"), rounding=ROUND_HALF_UP))",
    "    ",
    "    def get_expense_details(self, expense_id: str) -> Dict[str, Any]:",
    "        \"\"\"",
    "        Get detailed information about an expense.",
    "        ",
    "        Returns both original and converted amounts for audit purposes.",
    "        \"\"\"",
    "        expense = self._expenses.get(expense_id)",
    "        if not expense:",
    "            return None",
    "        ",
    "        return {",
    "            \"expense_id\": expense.expense_id,",
    "            \"employee_id\": expense.employee_id,",
    "            \"type\": expense.expense_type.value,",
    "            \"original_amount\": float(expense.original_amount),",
    "            \"original_currency\": expense.original_currency,",
    "            \"usd_amount\": float(expense.usd_amount),",
    "            \"exchange_rate\": float(expense.exchange_rate),",
    "            \"date\": expense.date,",
    "            \"details\": expense.details",
    "        }",
    "",
    "",
    "# ============================================================",
    "# DEMO AND TESTING",
    "# ============================================================",
    "",
    "def main():",
    "    \"\"\"Demonstrate the multi-currency expense system.\"\"\"",
    "    print(\"=\" * 60)",
    "    print(\"TRAVEL EXPENSE SYSTEM - Multi-Currency Demo\")",
    "    print(\"=\" * 60)",
    "    print()",
    "    ",
    "    # Initialize manager",
    "    manager = ExpenseManager()",
    "    ",
    "    # Set exchange rates",
    "    print(\"Setting exchange rates:\")",
    "    manager.set_exchange_rate(\"EUR\", 1.10)",
    "    print(\"  EUR \u2192 USD: 1.10\")",
    "    manager.set_exchange_rate(\"GBP\", 1.27)",
    "    print(\"  GBP \u2192 USD: 1.27\")",
    "    manager.set_exchange_rate(\"JPY\", 0.0067)",
    "    print(\"  JPY \u2192 USD: 0.0067\")",
    "    print()",
    "    ",
    "    # Add expenses for employee",
    "    print(\"Adding expenses for emp001:\")",
    "    print()",
    "    ",
    "    # Hotel in Paris",
    "    exp1 = manager.add_expense(",
    "        \"emp001\", \"HOTEL\", 180, \"EUR\", \"2024-03-15\", {\"nights\": 2}",
    "    )",
    "    details = manager.get_expense_details(exp1)",
    "    print(f\"  {exp1}: Hotel in Paris\")",
    "    print(f\"    Original: \u20ac{details['original_amount']}/night \u00d7 2 nights\")",
    "    print(f\"    Converted: ${details['usd_amount']:.2f}/night (rate: {details['exchange_rate']})\")",
    "    print()",
    "    ",
    "    # Transport in London",
    "    exp2 = manager.add_expense(",
    "        \"emp001\", \"TRANSPORT\", 50, \"GBP\", \"2024-03-16\", {}",
    "    )",
    "    details = manager.get_expense_details(exp2)",
    "    print(f\"  {exp2}: Transport in London\")",
    "    print(f\"    Original: \u00a3{details['original_amount']}\")",
    "    print(f\"    Converted: ${details['usd_amount']:.2f} (rate: {details['exchange_rate']})\")",
    "    print()",
    "    ",
    "    # Calculate reimbursement",
    "    total = manager.calculate_reimbursement(\"emp001\")",
    "    print(\"=\" * 60)",
    "    print(\"REIMBURSEMENT CALCULATION:\")",
    "    print(\"=\" * 60)",
    "    print(\"  Hotel:     \u20ac180/night \u00d7 1.10 = $198/night\")",
    "    print(\"             min($198, $200) \u00d7 2 = $396.00\")",
    "    print(\"  Transport: \u00a350 \u00d7 1.27 = $63.50 (no cap)\")",
    "    print(\"-\" * 60)",
    "    print(f\"  TOTAL REIMBURSEMENT: ${total:.2f}\")",
    "    print(\"=\" * 60)",
    "    print()",
    "    ",
    "    # Verify",
    "    assert total == 459.50, f\"Expected 459.50, got {total}\"",
    "    print(\"\u2713 All calculations verified!\")",
    "",
    "",
    "if __name__ == \"__main__\":",
    "    main()"
  ],
  "solution_java_lines": [
    "import java.math.BigDecimal;",
    "import java.math.RoundingMode;",
    "import java.time.LocalDate;",
    "import java.util.*;",
    "",
    "/**",
    " * Travel Expense Management System - Part 2: Multi-Currency Support",
    " * ",
    " * Handles international expense submission with currency conversion,",
    " * applying company reimbursement policies to calculate total amounts.",
    " */",
    "public class ExpenseSystem {",
    "",
    "    // ================================================================",
    "    // EXPENSE TYPE ENUM",
    "    // ================================================================",
    "    ",
    "    public enum ExpenseType {",
    "        FLIGHT, HOTEL, MEALS, TRANSPORT",
    "    }",
    "",
    "    // ================================================================",
    "    // CURRENCY CONVERTER SERVICE",
    "    // ================================================================",
    "    ",
    "    public static class CurrencyConverter {",
    "        private final Map<String, BigDecimal> rates;",
    "        ",
    "        public CurrencyConverter() {",
    "            this.rates = new HashMap<>();",
    "            this.rates.put(\"USD\", BigDecimal.ONE);",
    "        }",
    "        ",
    "        public void setRate(String currency, double rateToUsd) {",
    "            rates.put(currency.toUpperCase(), BigDecimal.valueOf(rateToUsd));",
    "        }",
    "        ",
    "        public BigDecimal convertToUsd(double amount, String currency) {",
    "            String curr = currency.toUpperCase();",
    "            if (!rates.containsKey(curr)) {",
    "                throw new IllegalArgumentException(\"Unknown currency: \" + curr);",
    "            }",
    "            return BigDecimal.valueOf(amount).multiply(rates.get(curr));",
    "        }",
    "        ",
    "        public BigDecimal getRate(String currency) {",
    "            return rates.get(currency.toUpperCase());",
    "        }",
    "    }",
    "",
    "    // ================================================================",
    "    // EXPENSE CLASS (with currency support)",
    "    // ================================================================",
    "    ",
    "    public static class Expense {",
    "        private final String expenseId;",
    "        private final String employeeId;",
    "        private final ExpenseType type;",
    "        private final BigDecimal originalAmount;",
    "        private final String originalCurrency;",
    "        private final BigDecimal usdAmount;",
    "        private final BigDecimal exchangeRate;",
    "        private final String date;",
    "        private final Map<String, Object> details;",
    "        ",
    "        public Expense(String expenseId, String employeeId, ExpenseType type,",
    "                       BigDecimal originalAmount, String originalCurrency,",
    "                       BigDecimal usdAmount, BigDecimal exchangeRate,",
    "                       String date, Map<String, Object> details) {",
    "            this.expenseId = expenseId;",
    "            this.employeeId = employeeId;",
    "            this.type = type;",
    "            this.originalAmount = originalAmount;",
    "            this.originalCurrency = originalCurrency;",
    "            this.usdAmount = usdAmount;",
    "            this.exchangeRate = exchangeRate;",
    "            this.date = date;",
    "            this.details = details != null ? details : new HashMap<>();",
    "        }",
    "        ",
    "        // Getters",
    "        public String getExpenseId() { return expenseId; }",
    "        public String getEmployeeId() { return employeeId; }",
    "        public ExpenseType getType() { return type; }",
    "        public BigDecimal getOriginalAmount() { return originalAmount; }",
    "        public String getOriginalCurrency() { return originalCurrency; }",
    "        public BigDecimal getUsdAmount() { return usdAmount; }",
    "        public BigDecimal getExchangeRate() { return exchangeRate; }",
    "        public String getDate() { return date; }",
    "        public Map<String, Object> getDetails() { return details; }",
    "    }",
    "",
    "    // ================================================================",
    "    // REIMBURSEMENT POLICIES (Strategy Pattern)",
    "    // ================================================================",
    "    ",
    "    public interface ReimbursementPolicy {",
    "        BigDecimal calculate(Expense expense);",
    "    }",
    "    ",
    "    public static class FlightPolicy implements ReimbursementPolicy {",
    "        private static final BigDecimal LIMIT = new BigDecimal(\"1000\");",
    "        ",
    "        @Override",
    "        public BigDecimal calculate(Expense expense) {",
    "            return expense.getUsdAmount().min(LIMIT);",
    "        }",
    "    }",
    "    ",
    "    public static class HotelPolicy implements ReimbursementPolicy {",
    "        private static final BigDecimal NIGHTLY_LIMIT = new BigDecimal(\"200\");",
    "        ",
    "        @Override",
    "        public BigDecimal calculate(Expense expense) {",
    "            int nights = (int) expense.getDetails().getOrDefault(\"nights\", 1);",
    "            BigDecimal cappedPerNight = expense.getUsdAmount().min(NIGHTLY_LIMIT);",
    "            return cappedPerNight.multiply(BigDecimal.valueOf(nights));",
    "        }",
    "    }",
    "    ",
    "    public static class MealsPolicy implements ReimbursementPolicy {",
    "        private static final BigDecimal DAILY_LIMIT = new BigDecimal(\"50\");",
    "        private static final BigDecimal RATE = new BigDecimal(\"0.5\");",
    "        ",
    "        @Override",
    "        public BigDecimal calculate(Expense expense) {",
    "            int days = (int) expense.getDetails().getOrDefault(\"days\", 1);",
    "            BigDecimal halfPerDay = expense.getUsdAmount().multiply(RATE);",
    "            BigDecimal cappedPerDay = halfPerDay.min(DAILY_LIMIT);",
    "            return cappedPerDay.multiply(BigDecimal.valueOf(days));",
    "        }",
    "    }",
    "    ",
    "    public static class TransportPolicy implements ReimbursementPolicy {",
    "        @Override",
    "        public BigDecimal calculate(Expense expense) {",
    "            return expense.getUsdAmount();",
    "        }",
    "    }",
    "",
    "    // ================================================================",
    "    // POLICY FACTORY",
    "    // ================================================================",
    "    ",
    "    public static class PolicyFactory {",
    "        private static final Map<ExpenseType, ReimbursementPolicy> policies;",
    "        ",
    "        static {",
    "            policies = new EnumMap<>(ExpenseType.class);",
    "            policies.put(ExpenseType.FLIGHT, new FlightPolicy());",
    "            policies.put(ExpenseType.HOTEL, new HotelPolicy());",
    "            policies.put(ExpenseType.MEALS, new MealsPolicy());",
    "            policies.put(ExpenseType.TRANSPORT, new TransportPolicy());",
    "        }",
    "        ",
    "        public static ReimbursementPolicy getPolicy(ExpenseType type) {",
    "            return policies.get(type);",
    "        }",
    "    }",
    "",
    "    // ================================================================",
    "    // EXPENSE MANAGER (Main Class)",
    "    // ================================================================",
    "    ",
    "    public static class ExpenseManager {",
    "        private final Map<String, Expense> expenses;",
    "        private final Map<String, List<String>> employeeExpenses;",
    "        private final CurrencyConverter currencyConverter;",
    "        private int expenseCounter;",
    "        ",
    "        public ExpenseManager() {",
    "            this.expenses = new HashMap<>();",
    "            this.employeeExpenses = new HashMap<>();",
    "            this.currencyConverter = new CurrencyConverter();",
    "            this.expenseCounter = 0;",
    "        }",
    "        ",
    "        /**",
    "         * Set or update exchange rate for a currency.",
    "         */",
    "        public void setExchangeRate(String currency, double rateToUsd) {",
    "            currencyConverter.setRate(currency, rateToUsd);",
    "        }",
    "        ",
    "        /**",
    "         * Add expense with multi-currency support.",
    "         */",
    "        public String addExpense(String employeeId, String type, double amount,",
    "                                 String currency, String date,",
    "                                 Map<String, Object> details) {",
    "            expenseCounter++;",
    "            String expenseId = \"exp_\" + expenseCounter;",
    "            ",
    "            if (details == null) {",
    "                details = new HashMap<>();",
    "            }",
    "            if (date == null) {",
    "                date = LocalDate.now().toString();",
    "            }",
    "            ",
    "            // Convert to USD immediately",
    "            BigDecimal usdAmount = currencyConverter.convertToUsd(amount, currency);",
    "            BigDecimal exchangeRate = currencyConverter.getRate(currency);",
    "            ",
    "            Expense expense = new Expense(",
    "                expenseId,",
    "                employeeId,",
    "                ExpenseType.valueOf(type.toUpperCase()),",
    "                BigDecimal.valueOf(amount),",
    "                currency.toUpperCase(),",
    "                usdAmount,",
    "                exchangeRate,",
    "                date,",
    "                details",
    "            );",
    "            ",
    "            expenses.put(expenseId, expense);",
    "            employeeExpenses.computeIfAbsent(employeeId, k -> new ArrayList<>())",
    "                           .add(expenseId);",
    "            ",
    "            return expenseId;",
    "        }",
    "        ",
    "        /**",
    "         * Calculate total reimbursement for an employee.",
    "         */",
    "        public double calculateReimbursement(String employeeId) {",
    "            List<String> expenseIds = employeeExpenses.get(employeeId);",
    "            if (expenseIds == null || expenseIds.isEmpty()) {",
    "                return 0.0;",
    "            }",
    "            ",
    "            BigDecimal total = BigDecimal.ZERO;",
    "            ",
    "            for (String expenseId : expenseIds) {",
    "                Expense expense = expenses.get(expenseId);",
    "                ReimbursementPolicy policy = PolicyFactory.getPolicy(expense.getType());",
    "                BigDecimal reimbursement = policy.calculate(expense);",
    "                total = total.add(reimbursement);",
    "            }",
    "            ",
    "            return total.setScale(2, RoundingMode.HALF_UP).doubleValue();",
    "        }",
    "    }",
    "",
    "    // ================================================================",
    "    // MAIN - Demo",
    "    // ================================================================",
    "    ",
    "    public static void main(String[] args) {",
    "        System.out.println(\"==========================================\");",
    "        System.out.println(\"TRAVEL EXPENSE SYSTEM - Multi-Currency Demo\");",
    "        System.out.println(\"==========================================\");",
    "        System.out.println();",
    "        ",
    "        ExpenseManager manager = new ExpenseManager();",
    "        ",
    "        // Set exchange rates",
    "        System.out.println(\"Setting exchange rates:\");",
    "        manager.setExchangeRate(\"EUR\", 1.10);",
    "        System.out.println(\"  EUR \u2192 USD: 1.10\");",
    "        manager.setExchangeRate(\"GBP\", 1.27);",
    "        System.out.println(\"  GBP \u2192 USD: 1.27\");",
    "        System.out.println();",
    "        ",
    "        // Add expenses",
    "        System.out.println(\"Adding expenses for emp001:\");",
    "        ",
    "        Map<String, Object> hotelDetails = new HashMap<>();",
    "        hotelDetails.put(\"nights\", 2);",
    "        String exp1 = manager.addExpense(",
    "            \"emp001\", \"HOTEL\", 180, \"EUR\", \"2024-03-15\", hotelDetails",
    "        );",
    "        System.out.println(\"  \" + exp1 + \": Hotel \u20ac180/night \u00d7 2 nights\");",
    "        ",
    "        String exp2 = manager.addExpense(",
    "            \"emp001\", \"TRANSPORT\", 50, \"GBP\", \"2024-03-16\", null",
    "        );",
    "        System.out.println(\"  \" + exp2 + \": Transport \u00a350\");",
    "        System.out.println();",
    "        ",
    "        // Calculate reimbursement",
    "        double total = manager.calculateReimbursement(\"emp001\");",
    "        System.out.println(\"==========================================\");",
    "        System.out.println(\"REIMBURSEMENT CALCULATION:\");",
    "        System.out.println(\"  Hotel: \u20ac180 \u00d7 1.10 \u00d7 2 = $396.00\");",
    "        System.out.println(\"  Transport: \u00a350 \u00d7 1.27 = $63.50\");",
    "        System.out.println(\"------------------------------------------\");",
    "        System.out.printf(\"  TOTAL: $%.2f%n\", total);",
    "        System.out.println(\"==========================================\");",
    "        ",
    "        // Verify",
    "        assert total == 459.50 : \"Expected 459.50, got \" + total;",
    "        System.out.println(\"\u2713 All calculations verified!\");",
    "    }",
    "}"
  ],
  "code_walkthrough": [
    {
      "lines": "1-15",
      "explanation": "Module docstring and imports. We use Decimal for precise financial calculations, ABC for abstract base classes, and Enum for type safety."
    },
    {
      "lines": "18-22",
      "explanation": "ExpenseType enum defines the four supported expense categories. Using enum prevents typos and enables IDE autocompletion."
    },
    {
      "lines": "25-65",
      "explanation": "NEW: CurrencyConverter service class. Manages exchange rates in a HashMap. convert_to_usd() multiplies amount by rate using Decimal precision. get_rate() returns the rate for audit purposes."
    },
    {
      "lines": "68-99",
      "explanation": "Enhanced Expense class now stores: original_amount, original_currency, usd_amount (converted), and exchange_rate (frozen at creation). This provides full audit trail."
    },
    {
      "lines": "105-140",
      "explanation": "ReimbursementPolicy classes (Strategy Pattern). Each policy's calculate() method now uses expense.usd_amount instead of raw amount. Logic unchanged from Part 1."
    },
    {
      "lines": "155-175",
      "explanation": "PolicyFactory (Factory Pattern) - unchanged from Part 1. Maps expense types to their policy implementations."
    },
    {
      "lines": "180-260",
      "explanation": "ExpenseManager is the main class. Key changes: (1) Contains CurrencyConverter instance, (2) set_exchange_rate() method added, (3) add_expense() converts to USD immediately and captures the rate."
    },
    {
      "lines": "220-245",
      "explanation": "CRITICAL: In add_expense(), we convert to USD BEFORE creating the Expense object. The exchange rate is captured at this moment and stored with the expense."
    },
    {
      "lines": "250-275",
      "explanation": "calculate_reimbursement() is largely unchanged - it iterates expenses and applies policies. The key difference is that expense.usd_amount is already converted, so policies work directly with USD."
    }
  ],
  "complexity_analysis": {
    "time": {
      "new_methods": {
        "setExchangeRate": {
          "complexity": "O(1)",
          "explanation": "HashMap insertion/update"
        },
        "addExpense": {
          "complexity": "O(1)",
          "explanation": "Rate lookup O(1), conversion O(1), object creation O(1), HashMap insertion O(1)"
        },
        "calculateReimbursement": {
          "complexity": "O(n)",
          "explanation": "Iterates all n expenses for employee, each policy calculation is O(1)"
        }
      },
      "overall_change": "No change from Part 1 - all operations maintain their original complexity. Currency conversion is O(1) and doesn't add overhead."
    },
    "space": {
      "additional_space": "O(c + n)",
      "explanation": "O(c) for storing c currency exchange rates in HashMap. O(n) for storing n expenses, but each expense now has 4 additional fields (original_amount, original_currency, usd_amount, exchange_rate). Constant factor increase per expense."
    }
  },
  "dry_run": {
    "example_input": "setExchangeRate('EUR', 1.1), setExchangeRate('GBP', 1.27), addExpense('emp001', 'HOTEL', 180, 'EUR', '2024-03-15', {nights: 2}), addExpense('emp001', 'TRANSPORT', 50, 'GBP', '2024-03-16', {}), calculateReimbursement('emp001')",
    "steps": [
      {
        "step": 1,
        "action": "setExchangeRate('EUR', 1.1)",
        "state": "rates = {'USD': 1.0, 'EUR': 1.1}",
        "explanation": "Store EUR rate in HashMap"
      },
      {
        "step": 2,
        "action": "setExchangeRate('GBP', 1.27)",
        "state": "rates = {'USD': 1.0, 'EUR': 1.1, 'GBP': 1.27}",
        "explanation": "Store GBP rate in HashMap"
      },
      {
        "step": 3,
        "action": "addExpense('emp001', 'HOTEL', 180, 'EUR', ...)",
        "state": "Convert: \u20ac180 \u00d7 1.1 = $198. Create exp_1 with usd_amount=$198, rate=1.1",
        "explanation": "Look up EUR rate, convert amount, create Expense with both original (\u20ac180) and USD ($198) amounts"
      },
      {
        "step": 4,
        "action": "addExpense('emp001', 'TRANSPORT', 50, 'GBP', ...)",
        "state": "Convert: \u00a350 \u00d7 1.27 = $63.50. Create exp_2 with usd_amount=$63.50",
        "explanation": "Look up GBP rate, convert, store both amounts"
      },
      {
        "step": 5,
        "action": "calculateReimbursement('emp001')",
        "state": "Iterate [exp_1, exp_2]",
        "explanation": "Get list of employee's expense IDs"
      },
      {
        "step": 6,
        "action": "Process exp_1 (HOTEL)",
        "state": "Policy: min($198, $200) \u00d7 2 nights = $396",
        "explanation": "HotelPolicy uses usd_amount=$198, applies $200/night cap, multiplies by nights"
      },
      {
        "step": 7,
        "action": "Process exp_2 (TRANSPORT)",
        "state": "Policy: $63.50 (no cap)",
        "explanation": "TransportPolicy returns full usd_amount"
      },
      {
        "step": 8,
        "action": "Sum and round",
        "state": "$396.00 + $63.50 = $459.50",
        "explanation": "Add all reimbursements, round to 2 decimal places"
      }
    ],
    "final_output": "459.5"
  },
  "edge_cases": [
    {
      "case": "Unknown currency",
      "handling": "Raise ValueError with clear message",
      "gotcha": "Must set exchange rate before adding expenses in that currency"
    },
    {
      "case": "USD expenses",
      "handling": "Works automatically since USD rate is 1.0 by default",
      "gotcha": "No conversion needed but same code path works"
    },
    {
      "case": "Rate changes after expense",
      "handling": "No effect - rate is frozen at creation time",
      "gotcha": "This is intentional for financial accuracy"
    },
    {
      "case": "Zero amount",
      "handling": "Works correctly - converts to $0",
      "gotcha": "May want to validate positive amounts in production"
    },
    {
      "case": "Very small rates (JPY)",
      "handling": "Decimal handles precision correctly",
      "gotcha": "Using float would lose precision for JPY (0.0067)"
    },
    {
      "case": "Employee with no expenses",
      "handling": "Returns 0.0",
      "gotcha": "Check for key existence before iteration"
    }
  ],
  "test_cases": [
    {
      "name": "Basic multi-currency flow",
      "input": "setExchangeRate('EUR', 1.1), addExpense('emp001', 'HOTEL', 180, 'EUR', date, {nights: 2}), calculateReimbursement('emp001')",
      "expected": "396.0",
      "explanation": "\u20ac180 \u00d7 1.1 = $198/night, min($198, $200) \u00d7 2 = $396"
    },
    {
      "name": "Mixed currencies same employee",
      "input": "Full example with EUR hotel and GBP transport",
      "expected": "459.5",
      "explanation": "$396 (hotel) + $63.50 (transport) = $459.50"
    },
    {
      "name": "Over nightly cap with conversion",
      "input": "setExchangeRate('EUR', 1.1), addExpense('emp001', 'HOTEL', 200, 'EUR', date, {nights: 1})",
      "expected": "200.0 (not 220)",
      "explanation": "\u20ac200 \u00d7 1.1 = $220, but cap is $200/night, so reimbursement = $200"
    },
    {
      "name": "Rate change after expense",
      "input": "Set EUR=1.1, add expense, change EUR=1.5, calculate",
      "expected": "Original rate (1.1) used",
      "explanation": "Rate is frozen at expense creation time"
    },
    {
      "name": "Unknown currency error",
      "input": "addExpense with 'XYZ' currency",
      "expected": "ValueError raised",
      "explanation": "Currency not in rates dictionary"
    }
  ],
  "common_mistakes": [
    {
      "mistake": "Converting at query time instead of creation time",
      "why_wrong": "If exchange rates change, the same expense would have different USD values at different times. This breaks financial consistency and audit requirements.",
      "correct_approach": "Convert to USD immediately in addExpense() and store the converted amount.",
      "code_example_wrong": "# WRONG: Converting in calculateReimbursement\ndef calculate(expense):\n    rate = converter.get_rate(expense.currency)  # Current rate!\n    usd = expense.amount * rate\n    return min(usd, limit)",
      "code_example_correct": "# CORRECT: Convert at creation\ndef add_expense(...):\n    usd_amount = converter.convert_to_usd(amount, currency)\n    expense = Expense(..., usd_amount=usd_amount)"
    },
    {
      "mistake": "Using float for currency calculations",
      "why_wrong": "Float arithmetic is imprecise. 0.1 + 0.2 = 0.30000000000000004. This causes rounding errors in financial calculations.",
      "correct_approach": "Use Decimal (Python) or BigDecimal (Java) for all currency values.",
      "code_example_wrong": "# WRONG\nrate = 1.10\nusd = amount * rate  # Float imprecision",
      "code_example_correct": "# CORRECT\nrate = Decimal('1.10')\nusd = Decimal(str(amount)) * rate"
    },
    {
      "mistake": "Not storing the exchange rate used",
      "why_wrong": "Without storing the rate, you can't audit or debug calculations later. You can't answer 'what rate was used for this expense?'",
      "correct_approach": "Store both original_currency, original_amount, usd_amount, AND exchange_rate in the Expense object.",
      "code_example_wrong": "# WRONG: No audit trail\nclass Expense:\n    def __init__(self, usd_amount):\n        self.amount = usd_amount  # Lost original info!",
      "code_example_correct": "# CORRECT: Full audit trail\nclass Expense:\n    def __init__(self, orig_amt, orig_curr, usd_amt, rate):\n        self.original_amount = orig_amt\n        self.original_currency = orig_curr\n        self.usd_amount = usd_amt\n        self.exchange_rate = rate"
    },
    {
      "mistake": "Applying policy before currency conversion",
      "why_wrong": "Policies are defined in USD terms (e.g., $200/night cap). Applying to EUR amounts gives wrong results.",
      "correct_approach": "Always convert to USD first, then apply policy.",
      "code_example_wrong": "# WRONG: Policy in original currency\ncapped = min(180, 200)  # Comparing EUR to USD limit!\nusd = capped * 1.10",
      "code_example_correct": "# CORRECT: Convert first\nusd = 180 * 1.10  # = $198\ncapped = min(usd, 200)  # = $198"
    }
  ],
  "interview_tips": {
    "how_to_present": "Start by clarifying the key design decision: 'Should we convert at submission time or query time?' Explain why submission time is correct (rate freezing, audit trail). Then show how this affects the Expense class design. Introduce CurrencyConverter as a separate service following SRP.",
    "what_to_mention": [
      "Discuss Decimal vs float precision explicitly - interviewers love this",
      "Explain the audit trail requirement and how your design supports it",
      "Note that rate lookup is O(1) so conversion doesn't add complexity",
      "Mention thread-safety considerations for rate updates in production",
      "Discuss how this design supports adding new currencies without code changes"
    ],
    "time_allocation": "8-10 minutes. Spend 2 min on design discussion, 5 min implementing changes, 2-3 min testing the example.",
    "if_stuck": [
      "Think about what happens if exchange rates change between expense submission and reimbursement calculation",
      "Consider what information you need for an audit: 'Show me exactly how this $396 was calculated'",
      "The Expense class needs to store more than just the amount - what else?",
      "Where should currency conversion logic live? (Hint: Single Responsibility)"
    ]
  },
  "connection_to_next_part": "Part 2 establishes the pattern of extending the system with new capabilities while maintaining backward compatibility. Part 3 might introduce expense approval workflows (state pattern), receipt attachment handling (decorator pattern), or time-based expense queries (requiring date indexing). The clean separation of concerns in this solution makes any of these extensions straightforward.",
  "generated_at": "2026-01-14T15:21:46.184355",
  "_meta": {
    "problem_id": "travel_expense_calculation",
    "part_number": 2,
    "model": "claude-opus-4-5-20251101"
  }
}