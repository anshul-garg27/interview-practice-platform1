{
  "problem_title": "Travel Expense Calculation System - Part 3: Per-Diem Calculations by Location",
  "part_number": 3,
  "builds_on": "Part 2",
  "difficulty": "hard",
  "problem_understanding": {
    "what_changes": "Part 3 introduces **location-based per-diem rates** and **trip management**. Instead of using fixed global reimbursement limits, the system now supports different limits for different cities based on cost of living. Expenses are grouped into trips with date ranges, and reimbursement calculations consider the trip's destination and duration.",
    "new_requirements": [
      "Store per-diem rates (hotel/meal limits) per location",
      "Create trips with employee, location, and date range",
      "Calculate days/nights from date range",
      "Override default limits with location-specific per-diem",
      "Group expenses under trips for unified calculation"
    ],
    "new_constraints": [
      "Hotel reimbursement capped at location's per-night limit",
      "Meal reimbursement: 50% of amount, capped at location's per-day limit",
      "Days calculated as (end - start) + 1 (inclusive)",
      "Nights calculated as (end - start)",
      "Locations without configured per-diem use default limits"
    ],
    "key_insight": "The AHA moment is recognizing that **reimbursement strategies need to be location-aware**. Rather than hardcoding limits, strategies should accept a LocationPerDiem configuration that overrides defaults. This follows the Open-Closed Principle - we extend behavior through configuration rather than modification."
  },
  "visual_explanation": {
    "before_after": "```\n\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551                    BEFORE (Parts 1-2)                            \u2551\n\u2560\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2563\n\u2551                                                                  \u2551\n\u2551    Individual Expense \u2500\u2500\u2500\u2500\u2500\u25ba Strategy \u2500\u2500\u2500\u2500\u2500\u25ba Fixed Limit         \u2551\n\u2551    (HOTEL, $300)              \u2502              ($200/night)        \u2551\n\u2551                               \u25bc                                  \u2551\n\u2551                          min($300, $200)                         \u2551\n\u2551                               \u2502                                  \u2551\n\u2551                               \u25bc                                  \u2551\n\u2551                         Reimburse: $200                          \u2551\n\u2551                                                                  \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n\n\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551                    AFTER (Part 3)                                \u2551\n\u2560\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2563\n\u2551                                                                  \u2551\n\u2551    Trip (NYC, Mar 15-18) \u2500\u2500\u2500\u2500\u2500\u25ba Location \u2500\u2500\u2500\u2500\u2500\u25ba Per-Diem Lookup  \u2551\n\u2551           \u2502                     Lookup         (NYC: $350/night) \u2551\n\u2551           \u25bc                                          \u2502           \u2551\n\u2551    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                  \u25bc           \u2551\n\u2551    \u2502 Expenses:    \u2502          Strategy \u25c4\u2500\u2500\u2500\u2500\u2500\u2500 Override Limit     \u2551\n\u2551    \u2502 \u2022 Hotel $1200\u2502              \u2502                               \u2551\n\u2551    \u2502 \u2022 Meals $400 \u2502              \u25bc                               \u2551\n\u2551    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     Calculate with NYC limits                \u2551\n\u2551                               \u2502                                  \u2551\n\u2551                               \u25bc                                  \u2551\n\u2551                         Reimburse: $1250                         \u2551\n\u2551                                                                  \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n```",
    "algorithm_flow": "```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              TRIP REIMBURSEMENT CALCULATION FLOW                    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                     \u2502\n\u2502  STEP 1: Create Trip                                                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  createTrip(\"emp001\", \"NYC\", \"2024-03-15\", \"2024-03-18\")     \u2502  \u2502\n\u2502  \u2502                           \u2502                                   \u2502  \u2502\n\u2502  \u2502                           \u25bc                                   \u2502  \u2502\n\u2502  \u2502  Trip { id: \"trip_1\", location: \"NYC\", days: 4, nights: 3 }  \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                     \u2502\n\u2502  STEP 2: Add Expenses to Trip                                       \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  addExpenseToTrip(\"trip_1\", \"HOTEL\", 1200, {nights: 3})      \u2502  \u2502\n\u2502  \u2502  addExpenseToTrip(\"trip_1\", \"MEAL\", 400, {days: 4})          \u2502  \u2502\n\u2502  \u2502                           \u2502                                   \u2502  \u2502\n\u2502  \u2502                           \u25bc                                   \u2502  \u2502\n\u2502  \u2502  Trip.expenses = [Hotel($1200, 3n), Meal($400, 4d)]          \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                     \u2502\n\u2502  STEP 3: Calculate with Location Per-Diem                           \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  calculateTripReimbursement(\"trip_1\")                         \u2502  \u2502\n\u2502  \u2502                           \u2502                                   \u2502  \u2502\n\u2502  \u2502         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                \u2502  \u2502\n\u2502  \u2502         \u25bc                                   \u25bc                \u2502  \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u2502  \u2502\n\u2502  \u2502  \u2502  HOTEL:         \u2502              \u2502  MEAL:          \u2502        \u2502  \u2502\n\u2502  \u2502  \u2502  $1200 / 3 = $400/n \u2502          \u2502  $400 / 4 = $100/d \u2502     \u2502  \u2502\n\u2502  \u2502  \u2502  NYC limit: $350/n  \u2502          \u2502  50%: $50/d       \u2502      \u2502  \u2502\n\u2502  \u2502  \u2502  min($400,$350)=$350\u2502          \u2502  NYC limit: $80/d \u2502      \u2502  \u2502\n\u2502  \u2502  \u2502  \u00d7 3 = $1050        \u2502          \u2502  min($50,$80)=$50 \u2502      \u2502  \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2502  \u00d7 4 = $200       \u2502      \u2502  \u2502\n\u2502  \u2502         \u2502                         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2502  \u2502\n\u2502  \u2502         \u2502                                   \u2502                \u2502  \u2502\n\u2502  \u2502         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                \u2502  \u2502\n\u2502  \u2502                           \u25bc                                   \u2502  \u2502\n\u2502  \u2502                   TOTAL: $1250.00                             \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```"
  },
  "approaches": [
    {
      "name": "Naive Extension - Inline Per-Diem Lookup",
      "description": "Add location-specific limits directly into each strategy's calculate method. Store per-diem in a global map accessed by strategies.",
      "time_complexity": "O(n) per trip calculation",
      "space_complexity": "O(L + T + E) where L=locations, T=trips, E=expenses",
      "why_not_optimal": "Tight coupling between strategies and per-diem storage. Strategies shouldn't need to know about the global per-diem registry. Makes testing difficult and violates Single Responsibility Principle."
    },
    {
      "name": "Optimal Approach - Injected Per-Diem Configuration",
      "description": "Pass LocationPerDiem configuration as a parameter to strategy.calculate(). The ExpenseManager looks up the per-diem based on trip location and injects it into the strategy. Strategies use the injected limits if provided, otherwise fall back to defaults.",
      "time_complexity": "O(n) per trip calculation where n = expenses in trip",
      "space_complexity": "O(L + T + E) for storing locations, trips, and expenses",
      "key_insight": "Dependency Injection for per-diem limits. Strategies remain stateless and testable. Location lookup happens once per trip, not per expense. Clean separation between location configuration and reimbursement logic."
    }
  ],
  "optimal_solution": {
    "explanation_md": "The optimal solution introduces three key components:\n\n**1. LocationPerDiem Data Class**\nStores the hotel and meal limits for each configured location. Uses a simple map lookup with normalized keys.\n\n**2. Trip Entity**\nEncapsulates trip data including employee, location, date range, and associated expenses. Provides computed properties for `days` and `nights`.\n\n**3. Modified Reimbursement Strategies**\nStrategies now accept optional `per_diem` and `trip` parameters. If per-diem is provided, use its limits; otherwise, fall back to defaults.\n\n**Key Design Decisions:**\n- **Dependency Injection**: Per-diem is passed to strategies rather than globally accessed\n- **Null Object Pattern**: Missing per-diem gracefully falls back to defaults\n- **Decimal Arithmetic**: Prevents floating-point errors in financial calculations\n- **Date Calculation**: Days = inclusive (end - start + 1), Nights = end - start",
    "data_structures": [
      {
        "structure": "Dict[str, LocationPerDiem]",
        "purpose": "O(1) lookup of per-diem rates by location"
      },
      {
        "structure": "Dict[str, Trip]",
        "purpose": "Store trips by ID for expense grouping"
      },
      {
        "structure": "List[Expense] per Trip",
        "purpose": "Group expenses under a single trip"
      },
      {
        "structure": "Decimal for amounts",
        "purpose": "Precise financial calculations"
      }
    ],
    "algorithm_steps": [
      "Step 1: setLocationPerDiem - Store hotel/meal limits in map keyed by uppercase location",
      "Step 2: createTrip - Parse dates, calculate days/nights, generate unique trip ID",
      "Step 3: addExpenseToTrip - Create Expense object, append to trip's expense list",
      "Step 4: calculateTripReimbursement - Lookup location per-diem, iterate expenses",
      "Step 5: For each expense - Get strategy, pass per-diem, accumulate reimbursement",
      "Step 6: Hotel calculation - amount/nights \u2192 cap at limit/night \u2192 multiply by nights",
      "Step 7: Meal calculation - amount/days \u2192 apply 50% \u2192 cap at limit/day \u2192 multiply by days"
    ]
  },
  "solution_python_lines": [
    "from abc import ABC, abstractmethod",
    "from dataclasses import dataclass, field",
    "from datetime import datetime, date",
    "from decimal import Decimal, ROUND_HALF_UP",
    "from typing import Dict, List, Optional, Any",
    "from enum import Enum",
    "import uuid",
    "",
    "",
    "class ExpenseType(Enum):",
    "    \"\"\"Supported expense categories.\"\"\"",
    "    FLIGHT = \"FLIGHT\"",
    "    HOTEL = \"HOTEL\"",
    "    MEAL = \"MEAL\"",
    "    TRANSPORT = \"TRANSPORT\"",
    "",
    "",
    "class Currency(Enum):",
    "    \"\"\"Supported currencies.\"\"\"",
    "    USD = \"USD\"",
    "    EUR = \"EUR\"",
    "    GBP = \"GBP\"",
    "    JPY = \"JPY\"",
    "",
    "",
    "@dataclass",
    "class LocationPerDiem:",
    "    \"\"\"Per-diem configuration for a specific location.\"\"\"",
    "    location: str",
    "    hotel_limit: Decimal  # Max per night",
    "    meal_limit: Decimal   # Max per day",
    "",
    "",
    "@dataclass",
    "class Expense:",
    "    \"\"\"Represents a single expense item.\"\"\"",
    "    expense_id: str",
    "    expense_type: ExpenseType",
    "    amount: Decimal",
    "    currency: Currency",
    "    details: Dict[str, Any] = field(default_factory=dict)",
    "",
    "    @classmethod",
    "    def create(cls, expense_type: ExpenseType, amount: float,",
    "               currency: Currency = Currency.USD,",
    "               details: Optional[Dict[str, Any]] = None) -> 'Expense':",
    "        return cls(",
    "            expense_id=str(uuid.uuid4()),",
    "            expense_type=expense_type,",
    "            amount=Decimal(str(amount)),",
    "            currency=currency,",
    "            details=details or {}",
    "        )",
    "",
    "",
    "@dataclass",
    "class Trip:",
    "    \"\"\"Represents a business trip with associated expenses.\"\"\"",
    "    trip_id: str",
    "    employee_id: str",
    "    location: str",
    "    start_date: date",
    "    end_date: date",
    "    expenses: List[Expense] = field(default_factory=list)",
    "",
    "    @property",
    "    def days(self) -> int:",
    "        \"\"\"Total days of the trip (inclusive).\"\"\"",
    "        return (self.end_date - self.start_date).days + 1",
    "",
    "    @property",
    "    def nights(self) -> int:",
    "        \"\"\"Total nights of the trip.\"\"\"",
    "        return (self.end_date - self.start_date).days",
    "",
    "    def add_expense(self, expense: Expense) -> None:",
    "        \"\"\"Add an expense to this trip.\"\"\"",
    "        self.expenses.append(expense)",
    "",
    "",
    "class ReimbursementStrategy(ABC):",
    "    \"\"\"Abstract base class for reimbursement calculation strategies.\"\"\"",
    "",
    "    @abstractmethod",
    "    def calculate(self, expense: Expense,",
    "                  per_diem: Optional[LocationPerDiem] = None,",
    "                  trip: Optional[Trip] = None) -> Decimal:",
    "        \"\"\"Calculate reimbursement amount for an expense.\"\"\"",
    "        pass",
    "",
    "",
    "class FlightReimbursementStrategy(ReimbursementStrategy):",
    "    \"\"\"100% reimbursed up to policy limit.\"\"\"",
    "",
    "    DEFAULT_LIMIT = Decimal(\"5000\")",
    "",
    "    def calculate(self, expense: Expense,",
    "                  per_diem: Optional[LocationPerDiem] = None,",
    "                  trip: Optional[Trip] = None) -> Decimal:",
    "        limit = expense.details.get(\"limit\", self.DEFAULT_LIMIT)",
    "        if isinstance(limit, (int, float)):",
    "            limit = Decimal(str(limit))",
    "        return min(expense.amount, limit)",
    "",
    "",
    "class HotelReimbursementStrategy(ReimbursementStrategy):",
    "    \"\"\"100% reimbursed up to per-night limit.\"\"\"",
    "",
    "    DEFAULT_LIMIT_PER_NIGHT = Decimal(\"200\")",
    "",
    "    def calculate(self, expense: Expense,",
    "                  per_diem: Optional[LocationPerDiem] = None,",
    "                  trip: Optional[Trip] = None) -> Decimal:",
    "        # Get number of nights",
    "        nights = expense.details.get(\"nights\", 1)",
    "        if trip and nights == 1 and \"nights\" not in expense.details:",
    "            nights = trip.nights",
    "",
    "        # Get limit per night (location-specific or default)",
    "        limit_per_night = self.DEFAULT_LIMIT_PER_NIGHT",
    "        if per_diem:",
    "            limit_per_night = per_diem.hotel_limit",
    "",
    "        # Calculate per-night amount and cap at limit",
    "        amount_per_night = expense.amount / Decimal(str(nights))",
    "        reimbursable_per_night = min(amount_per_night, limit_per_night)",
    "",
    "        return reimbursable_per_night * Decimal(str(nights))",
    "",
    "",
    "class MealReimbursementStrategy(ReimbursementStrategy):",
    "    \"\"\"50% reimbursed up to per-day limit.\"\"\"",
    "",
    "    REIMBURSEMENT_RATE = Decimal(\"0.5\")",
    "    DEFAULT_LIMIT_PER_DAY = Decimal(\"50\")",
    "",
    "    def calculate(self, expense: Expense,",
    "                  per_diem: Optional[LocationPerDiem] = None,",
    "                  trip: Optional[Trip] = None) -> Decimal:",
    "        # Get number of days",
    "        days = expense.details.get(\"days\", 1)",
    "        if trip and days == 1 and \"days\" not in expense.details:",
    "            days = trip.days",
    "",
    "        # Get limit per day (location-specific or default)",
    "        limit_per_day = self.DEFAULT_LIMIT_PER_DAY",
    "        if per_diem:",
    "            limit_per_day = per_diem.meal_limit",
    "",
    "        # Calculate per-day amount",
    "        amount_per_day = expense.amount / Decimal(str(days))",
    "",
    "        # Apply 50% rate first, then cap at daily limit",
    "        after_rate = amount_per_day * self.REIMBURSEMENT_RATE",
    "        reimbursable_per_day = min(after_rate, limit_per_day)",
    "",
    "        return reimbursable_per_day * Decimal(str(days))",
    "",
    "",
    "class TransportReimbursementStrategy(ReimbursementStrategy):",
    "    \"\"\"100% reimbursed with no limit.\"\"\"",
    "",
    "    def calculate(self, expense: Expense,",
    "                  per_diem: Optional[LocationPerDiem] = None,",
    "                  trip: Optional[Trip] = None) -> Decimal:",
    "        return expense.amount",
    "",
    "",
    "class StrategyFactory:",
    "    \"\"\"Factory for creating reimbursement strategies.\"\"\"",
    "",
    "    _strategies: Dict[ExpenseType, ReimbursementStrategy] = {",
    "        ExpenseType.FLIGHT: FlightReimbursementStrategy(),",
    "        ExpenseType.HOTEL: HotelReimbursementStrategy(),",
    "        ExpenseType.MEAL: MealReimbursementStrategy(),",
    "        ExpenseType.TRANSPORT: TransportReimbursementStrategy(),",
    "    }",
    "",
    "    @classmethod",
    "    def get_strategy(cls, expense_type: ExpenseType) -> ReimbursementStrategy:",
    "        strategy = cls._strategies.get(expense_type)",
    "        if not strategy:",
    "            raise ValueError(f\"No strategy for: {expense_type}\")",
    "        return strategy",
    "",
    "",
    "class CurrencyConverter:",
    "    \"\"\"Handles currency conversion (from Part 2).\"\"\"",
    "",
    "    def __init__(self):",
    "        self._rates: Dict[Currency, Decimal] = {",
    "            Currency.USD: Decimal(\"1.0\"),",
    "            Currency.EUR: Decimal(\"1.1\"),",
    "            Currency.GBP: Decimal(\"1.27\"),",
    "            Currency.JPY: Decimal(\"0.0067\"),",
    "        }",
    "",
    "    def set_rate(self, currency: Currency, rate_to_usd: float) -> None:",
    "        self._rates[currency] = Decimal(str(rate_to_usd))",
    "",
    "    def convert_to_usd(self, amount: Decimal, currency: Currency) -> Decimal:",
    "        rate = self._rates.get(currency, Decimal(\"1.0\"))",
    "        return (amount * rate).quantize(Decimal(\"0.01\"), rounding=ROUND_HALF_UP)",
    "",
    "",
    "class ExpenseManager:",
    "    \"\"\"",
    "    Main class for managing travel expenses with per-diem support.",
    "",
    "    Features:",
    "    - Multiple expense types with different reimbursement policies",
    "    - Multi-currency conversion",
    "    - Location-based per-diem rates",
    "    - Trip-based expense grouping",
    "    \"\"\"",
    "",
    "    def __init__(self):",
    "        self._expenses: Dict[str, Expense] = {}",
    "        self._trips: Dict[str, Trip] = {}",
    "        self._location_per_diems: Dict[str, LocationPerDiem] = {}",
    "        self._currency_converter = CurrencyConverter()",
    "        self._trip_counter = 0",
    "",
    "    # === Part 2: Currency Methods ===",
    "",
    "    def set_exchange_rate(self, currency: str, rate: float) -> None:",
    "        \"\"\"Set exchange rate for a currency to USD.\"\"\"",
    "        try:",
    "            curr = Currency[currency.upper()]",
    "            self._currency_converter.set_rate(curr, rate)",
    "        except KeyError:",
    "            raise ValueError(f\"Unknown currency: {currency}\")",
    "",
    "    # === Part 3: Location Per-Diem Methods ===",
    "",
    "    def set_location_per_diem(self, location: str, hotel_limit: float,",
    "                              meal_limit: float) -> None:",
    "        \"\"\"",
    "        Set per-diem rates for a specific location.",
    "",
    "        Args:",
    "            location: City/location name",
    "            hotel_limit: Maximum hotel reimbursement per night",
    "            meal_limit: Maximum meal reimbursement per day",
    "        \"\"\"",
    "        normalized = location.upper()",
    "        self._location_per_diems[normalized] = LocationPerDiem(",
    "            location=location,",
    "            hotel_limit=Decimal(str(hotel_limit)),",
    "            meal_limit=Decimal(str(meal_limit))",
    "        )",
    "",
    "    def _get_per_diem(self, location: str) -> Optional[LocationPerDiem]:",
    "        \"\"\"Get per-diem config for a location, None for default.\"\"\"",
    "        return self._location_per_diems.get(location.upper())",
    "",
    "    # === Part 3: Trip Management Methods ===",
    "",
    "    def create_trip(self, employee_id: str, location: str,",
    "                    start_date: str, end_date: str) -> str:",
    "        \"\"\"",
    "        Create a new business trip.",
    "",
    "        Args:",
    "            employee_id: Employee taking the trip",
    "            location: Travel destination",
    "            start_date: Trip start date (YYYY-MM-DD)",
    "            end_date: Trip end date (YYYY-MM-DD)",
    "",
    "        Returns:",
    "            Unique trip ID",
    "        \"\"\"",
    "        self._trip_counter += 1",
    "        trip_id = f\"trip_{self._trip_counter}\"",
    "",
    "        start = datetime.strptime(start_date, \"%Y-%m-%d\").date()",
    "        end = datetime.strptime(end_date, \"%Y-%m-%d\").date()",
    "",
    "        trip = Trip(",
    "            trip_id=trip_id,",
    "            employee_id=employee_id,",
    "            location=location,",
    "            start_date=start,",
    "            end_date=end",
    "        )",
    "",
    "        self._trips[trip_id] = trip",
    "        return trip_id",
    "",
    "    def add_expense_to_trip(self, trip_id: str, expense_type: str,",
    "                           amount: float, details: Dict[str, Any]) -> None:",
    "        \"\"\"",
    "        Add an expense to an existing trip.",
    "",
    "        Args:",
    "            trip_id: Trip to add expense to",
    "            expense_type: Type (FLIGHT, HOTEL, MEAL, TRANSPORT)",
    "            amount: Expense amount in USD",
    "            details: Additional details (nights, days, etc.)",
    "        \"\"\"",
    "        if trip_id not in self._trips:",
    "            raise ValueError(f\"Trip not found: {trip_id}\")",
    "",
    "        exp_type = ExpenseType[expense_type.upper()]",
    "        expense = Expense.create(exp_type, amount, Currency.USD, details)",
    "        self._trips[trip_id].add_expense(expense)",
    "",
    "    def calculate_trip_reimbursement(self, trip_id: str) -> float:",
    "        \"\"\"",
    "        Calculate total reimbursement for a trip.",
    "",
    "        Applies location-specific per-diem rates.",
    "",
    "        Args:",
    "            trip_id: Trip to calculate",
    "",
    "        Returns:",
    "            Total reimbursement amount in USD",
    "        \"\"\"",
    "        if trip_id not in self._trips:",
    "            raise ValueError(f\"Trip not found: {trip_id}\")",
    "",
    "        trip = self._trips[trip_id]",
    "        per_diem = self._get_per_diem(trip.location)",
    "",
    "        total = Decimal(\"0\")",
    "",
    "        for expense in trip.expenses:",
    "            strategy = StrategyFactory.get_strategy(expense.expense_type)",
    "            reimbursement = strategy.calculate(expense, per_diem, trip)",
    "            total += reimbursement",
    "",
    "        return float(total.quantize(Decimal(\"0.01\"), rounding=ROUND_HALF_UP))",
    "",
    "    # === Legacy Methods (Part 1) ===",
    "",
    "    def add_expense(self, expense_type: str, amount: float,",
    "                   currency: str = \"USD\", **details) -> str:",
    "        \"\"\"Add a standalone expense (legacy method).\"\"\"",
    "        exp_type = ExpenseType[expense_type.upper()]",
    "        curr = Currency[currency.upper()]",
    "        expense = Expense.create(exp_type, amount, curr, details)",
    "        self._expenses[expense.expense_id] = expense",
    "        return expense.expense_id",
    "",
    "    def calculate_reimbursement(self, expense_id: str) -> float:",
    "        \"\"\"Calculate reimbursement for a standalone expense.\"\"\"",
    "        if expense_id not in self._expenses:",
    "            raise ValueError(f\"Expense not found: {expense_id}\")",
    "",
    "        expense = self._expenses[expense_id]",
    "        amount_usd = self._currency_converter.convert_to_usd(",
    "            expense.amount, expense.currency",
    "        )",
    "",
    "        expense_usd = Expense(",
    "            expense_id=expense.expense_id,",
    "            expense_type=expense.expense_type,",
    "            amount=amount_usd,",
    "            currency=Currency.USD,",
    "            details=expense.details",
    "        )",
    "",
    "        strategy = StrategyFactory.get_strategy(expense.expense_type)",
    "        result = strategy.calculate(expense_usd)",
    "        return float(result.quantize(Decimal(\"0.01\"), rounding=ROUND_HALF_UP))",
    "",
    "",
    "def main():",
    "    \"\"\"Demonstrate the expense system with per-diem support.\"\"\"",
    "",
    "    print(\"=\" * 60)",
    "    print(\"Travel Expense System - Part 3: Per-Diem Support\")",
    "    print(\"=\" * 60)",
    "",
    "    manager = ExpenseManager()",
    "",
    "    # Set up location per-diem rates",
    "    print(\"\\n\ud83d\udccd Setting up location per-diem rates...\")",
    "    manager.set_location_per_diem(\"NYC\", 350, 80)",
    "    manager.set_location_per_diem(\"San Francisco\", 300, 75)",
    "    manager.set_location_per_diem(\"Austin\", 180, 60)",
    "    print(\"   NYC: Hotel $350/night, Meals $80/day\")",
    "    print(\"   SF:  Hotel $300/night, Meals $75/day\")",
    "    print(\"   Austin: Hotel $180/night, Meals $60/day\")",
    "",
    "    # Example: NYC Trip (from problem statement)",
    "    print(\"\\n\" + \"=\" * 60)",
    "    print(\"Example: NYC Business Trip (March 15-18)\")",
    "    print(\"=\" * 60)",
    "",
    "    trip_id = manager.create_trip(\"emp001\", \"NYC\", \"2024-03-15\", \"2024-03-18\")",
    "    print(f\"\\n\u2708\ufe0f  Created trip: {trip_id}\")",
    "    print(\"   Duration: 4 days, 3 nights\")",
    "",
    "    manager.add_expense_to_trip(trip_id, \"HOTEL\", 1200, {\"nights\": 3})",
    "    print(\"\\n\ud83c\udfe8 Hotel expense:\")",
    "    print(\"   Submitted: $400/night \u00d7 3 = $1200\")",
    "    print(\"   NYC limit: $350/night\")",
    "    print(\"   Reimburse: min($400, $350) \u00d7 3 = $1050\")",
    "",
    "    manager.add_expense_to_trip(trip_id, \"MEAL\", 400, {\"days\": 4})",
    "    print(\"\\n\ud83c\udf7d\ufe0f  Meal expense:\")",
    "    print(\"   Submitted: $100/day \u00d7 4 = $400\")",
    "    print(\"   50% rule: $50/day\")",
    "    print(\"   NYC limit: $80/day (not hit)\")",
    "    print(\"   Reimburse: $50 \u00d7 4 = $200\")",
    "",
    "    total = manager.calculate_trip_reimbursement(trip_id)",
    "    print(f\"\\n\ud83d\udcb0 Total Reimbursement: ${total:.2f}\")",
    "",
    "    assert total == 1250.0, f\"Expected $1250, got ${total}\"",
    "    print(\"   \u2705 Verified: $1050 + $200 = $1250\")",
    "",
    "    print(\"\\n\" + \"=\" * 60)",
    "    print(\"\u2705 All tests passed!\")",
    "    print(\"=\" * 60)",
    "",
    "",
    "if __name__ == \"__main__\":",
    "    main()"
  ],
  "solution_java_lines": [
    "import java.math.BigDecimal;",
    "import java.math.RoundingMode;",
    "import java.time.LocalDate;",
    "import java.time.format.DateTimeFormatter;",
    "import java.time.temporal.ChronoUnit;",
    "import java.util.*;",
    "",
    "// Expense type enumeration",
    "enum ExpenseType {",
    "    FLIGHT, HOTEL, MEAL, TRANSPORT",
    "}",
    "",
    "// Currency enumeration",
    "enum Currency {",
    "    USD, EUR, GBP, JPY",
    "}",
    "",
    "// Per-diem configuration for a location",
    "class LocationPerDiem {",
    "    private final String location;",
    "    private final BigDecimal hotelLimit;",
    "    private final BigDecimal mealLimit;",
    "",
    "    public LocationPerDiem(String location, BigDecimal hotelLimit, BigDecimal mealLimit) {",
    "        this.location = location;",
    "        this.hotelLimit = hotelLimit;",
    "        this.mealLimit = mealLimit;",
    "    }",
    "",
    "    public String getLocation() { return location; }",
    "    public BigDecimal getHotelLimit() { return hotelLimit; }",
    "    public BigDecimal getMealLimit() { return mealLimit; }",
    "}",
    "",
    "// Expense data class",
    "class Expense {",
    "    private final String expenseId;",
    "    private final ExpenseType expenseType;",
    "    private final BigDecimal amount;",
    "    private final Currency currency;",
    "    private final Map<String, Object> details;",
    "",
    "    public Expense(String expenseId, ExpenseType type, BigDecimal amount,",
    "                   Currency currency, Map<String, Object> details) {",
    "        this.expenseId = expenseId;",
    "        this.expenseType = type;",
    "        this.amount = amount;",
    "        this.currency = currency;",
    "        this.details = details != null ? details : new HashMap<>();",
    "    }",
    "",
    "    public static Expense create(ExpenseType type, double amount,",
    "                                 Currency currency, Map<String, Object> details) {",
    "        return new Expense(",
    "            UUID.randomUUID().toString(),",
    "            type,",
    "            BigDecimal.valueOf(amount),",
    "            currency,",
    "            details",
    "        );",
    "    }",
    "",
    "    public String getExpenseId() { return expenseId; }",
    "    public ExpenseType getExpenseType() { return expenseType; }",
    "    public BigDecimal getAmount() { return amount; }",
    "    public Currency getCurrency() { return currency; }",
    "    public Map<String, Object> getDetails() { return details; }",
    "}",
    "",
    "// Trip data class",
    "class Trip {",
    "    private final String tripId;",
    "    private final String employeeId;",
    "    private final String location;",
    "    private final LocalDate startDate;",
    "    private final LocalDate endDate;",
    "    private final List<Expense> expenses;",
    "",
    "    public Trip(String tripId, String employeeId, String location,",
    "                LocalDate startDate, LocalDate endDate) {",
    "        this.tripId = tripId;",
    "        this.employeeId = employeeId;",
    "        this.location = location;",
    "        this.startDate = startDate;",
    "        this.endDate = endDate;",
    "        this.expenses = new ArrayList<>();",
    "    }",
    "",
    "    public int getDays() {",
    "        return (int) ChronoUnit.DAYS.between(startDate, endDate) + 1;",
    "    }",
    "",
    "    public int getNights() {",
    "        return (int) ChronoUnit.DAYS.between(startDate, endDate);",
    "    }",
    "",
    "    public void addExpense(Expense expense) {",
    "        expenses.add(expense);",
    "    }",
    "",
    "    public String getTripId() { return tripId; }",
    "    public String getLocation() { return location; }",
    "    public List<Expense> getExpenses() { return expenses; }",
    "}",
    "",
    "// Abstract reimbursement strategy",
    "abstract class ReimbursementStrategy {",
    "    public abstract BigDecimal calculate(Expense expense,",
    "                                         LocationPerDiem perDiem,",
    "                                         Trip trip);",
    "}",
    "",
    "// Flight strategy: 100% up to limit",
    "class FlightReimbursementStrategy extends ReimbursementStrategy {",
    "    private static final BigDecimal DEFAULT_LIMIT = new BigDecimal(\"5000\");",
    "",
    "    @Override",
    "    public BigDecimal calculate(Expense expense, LocationPerDiem perDiem, Trip trip) {",
    "        Object limitObj = expense.getDetails().get(\"limit\");",
    "        BigDecimal limit = limitObj != null",
    "            ? BigDecimal.valueOf(((Number) limitObj).doubleValue())",
    "            : DEFAULT_LIMIT;",
    "        return expense.getAmount().min(limit);",
    "    }",
    "}",
    "",
    "// Hotel strategy: 100% up to per-night limit",
    "class HotelReimbursementStrategy extends ReimbursementStrategy {",
    "    private static final BigDecimal DEFAULT_LIMIT = new BigDecimal(\"200\");",
    "",
    "    @Override",
    "    public BigDecimal calculate(Expense expense, LocationPerDiem perDiem, Trip trip) {",
    "        // Get nights from details or trip",
    "        int nights = 1;",
    "        Object nightsObj = expense.getDetails().get(\"nights\");",
    "        if (nightsObj != null) {",
    "            nights = ((Number) nightsObj).intValue();",
    "        } else if (trip != null) {",
    "            nights = trip.getNights();",
    "        }",
    "",
    "        // Get limit (location-specific or default)",
    "        BigDecimal limitPerNight = perDiem != null",
    "            ? perDiem.getHotelLimit()",
    "            : DEFAULT_LIMIT;",
    "",
    "        // Calculate per-night and cap",
    "        BigDecimal amountPerNight = expense.getAmount()",
    "            .divide(BigDecimal.valueOf(nights), 10, RoundingMode.HALF_UP);",
    "        BigDecimal reimbursablePerNight = amountPerNight.min(limitPerNight);",
    "",
    "        return reimbursablePerNight.multiply(BigDecimal.valueOf(nights));",
    "    }",
    "}",
    "",
    "// Meal strategy: 50% up to per-day limit",
    "class MealReimbursementStrategy extends ReimbursementStrategy {",
    "    private static final BigDecimal RATE = new BigDecimal(\"0.5\");",
    "    private static final BigDecimal DEFAULT_LIMIT = new BigDecimal(\"50\");",
    "",
    "    @Override",
    "    public BigDecimal calculate(Expense expense, LocationPerDiem perDiem, Trip trip) {",
    "        // Get days from details or trip",
    "        int days = 1;",
    "        Object daysObj = expense.getDetails().get(\"days\");",
    "        if (daysObj != null) {",
    "            days = ((Number) daysObj).intValue();",
    "        } else if (trip != null) {",
    "            days = trip.getDays();",
    "        }",
    "",
    "        // Get limit (location-specific or default)",
    "        BigDecimal limitPerDay = perDiem != null",
    "            ? perDiem.getMealLimit()",
    "            : DEFAULT_LIMIT;",
    "",
    "        // Calculate per-day, apply 50%, then cap",
    "        BigDecimal amountPerDay = expense.getAmount()",
    "            .divide(BigDecimal.valueOf(days), 10, RoundingMode.HALF_UP);",
    "        BigDecimal afterRate = amountPerDay.multiply(RATE);",
    "        BigDecimal reimbursablePerDay = afterRate.min(limitPerDay);",
    "",
    "        return reimbursablePerDay.multiply(BigDecimal.valueOf(days));",
    "    }",
    "}",
    "",
    "// Transport strategy: 100% no limit",
    "class TransportReimbursementStrategy extends ReimbursementStrategy {",
    "    @Override",
    "    public BigDecimal calculate(Expense expense, LocationPerDiem perDiem, Trip trip) {",
    "        return expense.getAmount();",
    "    }",
    "}",
    "",
    "// Strategy factory",
    "class StrategyFactory {",
    "    private static final Map<ExpenseType, ReimbursementStrategy> strategies = new HashMap<>();",
    "",
    "    static {",
    "        strategies.put(ExpenseType.FLIGHT, new FlightReimbursementStrategy());",
    "        strategies.put(ExpenseType.HOTEL, new HotelReimbursementStrategy());",
    "        strategies.put(ExpenseType.MEAL, new MealReimbursementStrategy());",
    "        strategies.put(ExpenseType.TRANSPORT, new TransportReimbursementStrategy());",
    "    }",
    "",
    "    public static ReimbursementStrategy getStrategy(ExpenseType type) {",
    "        ReimbursementStrategy strategy = strategies.get(type);",
    "        if (strategy == null) {",
    "            throw new IllegalArgumentException(\"No strategy for: \" + type);",
    "        }",
    "        return strategy;",
    "    }",
    "}",
    "",
    "// Main expense manager class",
    "public class ExpenseManager {",
    "    private final Map<String, Expense> expenses = new HashMap<>();",
    "    private final Map<String, Trip> trips = new HashMap<>();",
    "    private final Map<String, LocationPerDiem> locationPerDiems = new HashMap<>();",
    "    private int tripCounter = 0;",
    "",
    "    // Part 3: Set location per-diem rates",
    "    public void setLocationPerDiem(String location, double hotelLimit, double mealLimit) {",
    "        String normalized = location.toUpperCase();",
    "        locationPerDiems.put(normalized, new LocationPerDiem(",
    "            location,",
    "            BigDecimal.valueOf(hotelLimit),",
    "            BigDecimal.valueOf(mealLimit)",
    "        ));",
    "    }",
    "",
    "    private LocationPerDiem getPerDiem(String location) {",
    "        return locationPerDiems.get(location.toUpperCase());",
    "    }",
    "",
    "    // Part 3: Create a trip",
    "    public String createTrip(String employeeId, String location,",
    "                             String startDate, String endDate) {",
    "        tripCounter++;",
    "        String tripId = \"trip_\" + tripCounter;",
    "",
    "        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(\"yyyy-MM-dd\");",
    "        LocalDate start = LocalDate.parse(startDate, formatter);",
    "        LocalDate end = LocalDate.parse(endDate, formatter);",
    "",
    "        Trip trip = new Trip(tripId, employeeId, location, start, end);",
    "        trips.put(tripId, trip);",
    "        return tripId;",
    "    }",
    "",
    "    // Part 3: Add expense to trip",
    "    public void addExpenseToTrip(String tripId, String type,",
    "                                 double amount, Map<String, Object> details) {",
    "        Trip trip = trips.get(tripId);",
    "        if (trip == null) {",
    "            throw new IllegalArgumentException(\"Trip not found: \" + tripId);",
    "        }",
    "",
    "        ExpenseType expType = ExpenseType.valueOf(type.toUpperCase());",
    "        Expense expense = Expense.create(expType, amount, Currency.USD, details);",
    "        trip.addExpense(expense);",
    "    }",
    "",
    "    // Part 3: Calculate trip reimbursement",
    "    public double calculateTripReimbursement(String tripId) {",
    "        Trip trip = trips.get(tripId);",
    "        if (trip == null) {",
    "            throw new IllegalArgumentException(\"Trip not found: \" + tripId);",
    "        }",
    "",
    "        LocationPerDiem perDiem = getPerDiem(trip.getLocation());",
    "        BigDecimal total = BigDecimal.ZERO;",
    "",
    "        for (Expense expense : trip.getExpenses()) {",
    "            ReimbursementStrategy strategy = StrategyFactory.getStrategy(",
    "                expense.getExpenseType()",
    "            );",
    "            BigDecimal reimbursement = strategy.calculate(expense, perDiem, trip);",
    "            total = total.add(reimbursement);",
    "        }",
    "",
    "        return total.setScale(2, RoundingMode.HALF_UP).doubleValue();",
    "    }",
    "",
    "    // Main method for testing",
    "    public static void main(String[] args) {",
    "        System.out.println(\"=\".repeat(60));",
    "        System.out.println(\"Travel Expense System - Part 3: Per-Diem Support\");",
    "        System.out.println(\"=\".repeat(60));",
    "",
    "        ExpenseManager manager = new ExpenseManager();",
    "",
    "        // Setup per-diem rates",
    "        manager.setLocationPerDiem(\"NYC\", 350, 80);",
    "        System.out.println(\"\\nConfigured NYC: Hotel $350/night, Meals $80/day\");",
    "",
    "        // Create NYC trip",
    "        String tripId = manager.createTrip(\"emp001\", \"NYC\", \"2024-03-15\", \"2024-03-18\");",
    "        System.out.println(\"\\nCreated trip: \" + tripId);",
    "",
    "        // Add expenses",
    "        Map<String, Object> hotelDetails = new HashMap<>();",
    "        hotelDetails.put(\"nights\", 3);",
    "        manager.addExpenseToTrip(tripId, \"HOTEL\", 1200, hotelDetails);",
    "",
    "        Map<String, Object> mealDetails = new HashMap<>();",
    "        mealDetails.put(\"days\", 4);",
    "        manager.addExpenseToTrip(tripId, \"MEAL\", 400, mealDetails);",
    "",
    "        // Calculate",
    "        double total = manager.calculateTripReimbursement(tripId);",
    "        System.out.println(\"\\nTotal Reimbursement: $\" + total);",
    "        System.out.println(\"Expected: $1250.00\");",
    "",
    "        if (Math.abs(total - 1250.0) < 0.01) {",
    "            System.out.println(\"\\n\u2705 Test PASSED!\");",
    "        } else {",
    "            System.out.println(\"\\n\u274c Test FAILED!\");",
    "        }",
    "    }",
    "}"
  ],
  "code_walkthrough": [
    {
      "lines": "1-8",
      "explanation": "**Imports**: Essential libraries for dates, decimal arithmetic, and data structures"
    },
    {
      "lines": "10-25",
      "explanation": "**Enums**: ExpenseType and Currency enums for type safety"
    },
    {
      "lines": "27-45",
      "explanation": "**LocationPerDiem**: New data class storing hotel and meal limits per location. Uses Decimal/BigDecimal for precision."
    },
    {
      "lines": "47-75",
      "explanation": "**Expense**: Immutable expense with factory method. Details map holds nights/days for calculations."
    },
    {
      "lines": "77-110",
      "explanation": "**Trip**: Core Part 3 entity. Computed properties for days (inclusive) and nights. Maintains list of expenses."
    },
    {
      "lines": "112-130",
      "explanation": "**ReimbursementStrategy**: Abstract base with new signature accepting LocationPerDiem and Trip parameters."
    },
    {
      "lines": "132-155",
      "explanation": "**HotelReimbursementStrategy**: Gets nights from details or trip. Uses location per-diem limit if available, else default $200. Calculates per-night then caps."
    },
    {
      "lines": "157-185",
      "explanation": "**MealReimbursementStrategy**: Gets days from details or trip. Applies 50% rate first, then caps at location limit (or default $50). Key formula: min(amount \u00d7 0.5, limit) \u00d7 days"
    },
    {
      "lines": "200-240",
      "explanation": "**ExpenseManager.setLocationPerDiem**: Stores per-diem config with normalized uppercase key for case-insensitive lookup."
    },
    {
      "lines": "242-280",
      "explanation": "**ExpenseManager.createTrip**: Parses date strings, creates Trip entity, assigns sequential ID. O(1) operation."
    },
    {
      "lines": "282-310",
      "explanation": "**ExpenseManager.addExpenseToTrip**: Validates trip exists, creates Expense, appends to trip's list. O(1) operation."
    },
    {
      "lines": "312-345",
      "explanation": "**ExpenseManager.calculateTripReimbursement**: The core algorithm - looks up location per-diem once, iterates expenses, accumulates with strategies. O(n) where n = expenses."
    }
  ],
  "complexity_analysis": {
    "time": {
      "new_methods": {
        "setLocationPerDiem": {
          "complexity": "O(1)",
          "explanation": "Hash map insertion"
        },
        "createTrip": {
          "complexity": "O(1)",
          "explanation": "Date parsing and hash map insertion"
        },
        "addExpenseToTrip": {
          "complexity": "O(1)",
          "explanation": "Hash lookup + list append"
        },
        "calculateTripReimbursement": {
          "complexity": "O(n)",
          "explanation": "Iterates through all expenses in the trip"
        }
      },
      "overall_change": "Part 3 adds O(n) calculation per trip where n = number of expenses. Per-diem lookup is O(1)."
    },
    "space": {
      "additional_space": "O(L + T + E)",
      "explanation": "L = number of configured locations, T = number of trips, E = total expenses across all trips. Each trip stores its own list of expenses."
    }
  },
  "dry_run": {
    "example_input": "NYC trip Mar 15-18 with $1200 hotel (3 nights) and $400 meals (4 days)",
    "steps": [
      {
        "step": 1,
        "action": "setLocationPerDiem(\"NYC\", 350, 80)",
        "state": "perDiems = {\"NYC\": {hotel: 350, meal: 80}}",
        "explanation": "Store NYC limits"
      },
      {
        "step": 2,
        "action": "createTrip(\"emp001\", \"NYC\", \"2024-03-15\", \"2024-03-18\")",
        "state": "trips[\"trip_1\"] = Trip{days=4, nights=3}",
        "explanation": "Create trip, calculate 4 days and 3 nights"
      },
      {
        "step": 3,
        "action": "addExpenseToTrip(\"trip_1\", \"HOTEL\", 1200, {nights:3})",
        "state": "trip_1.expenses += Hotel($1200)",
        "explanation": "Add hotel expense to trip"
      },
      {
        "step": 4,
        "action": "addExpenseToTrip(\"trip_1\", \"MEAL\", 400, {days:4})",
        "state": "trip_1.expenses += Meal($400)",
        "explanation": "Add meal expense to trip"
      },
      {
        "step": 5,
        "action": "calculateTripReimbursement(\"trip_1\"): Hotel",
        "state": "$1200 / 3 = $400/night \u2192 min($400, $350) = $350 \u2192 $350 \u00d7 3 = $1050",
        "explanation": "Per-night exceeds NYC limit, capped at $350"
      },
      {
        "step": 6,
        "action": "calculateTripReimbursement(\"trip_1\"): Meal",
        "state": "$400 / 4 = $100/day \u2192 $100 \u00d7 0.5 = $50 \u2192 min($50, $80) = $50 \u2192 $50 \u00d7 4 = $200",
        "explanation": "50% rate ($50) is less than NYC limit ($80), so $50 applies"
      },
      {
        "step": 7,
        "action": "Sum totals",
        "state": "$1050 + $200 = $1250",
        "explanation": "Final reimbursement"
      }
    ],
    "final_output": "1250.0"
  },
  "edge_cases": [
    {
      "case": "Unknown location (no per-diem configured)",
      "handling": "Falls back to default limits: Hotel $200/night, Meals $50/day",
      "gotcha": "Don't throw error for unknown locations - gracefully degrade to defaults"
    },
    {
      "case": "50% of meal exceeds location limit",
      "handling": "When (amount \u00d7 0.5) > location_limit, cap at location_limit",
      "gotcha": "Apply 50% BEFORE checking against limit, as shown in the example"
    },
    {
      "case": "Same-day trip (start == end)",
      "handling": "days = 1, nights = 0. Hotel should handle 0 nights gracefully",
      "gotcha": "Avoid division by zero when nights = 0"
    },
    {
      "case": "Trip with no expenses",
      "handling": "Returns 0.0 reimbursement",
      "gotcha": "Empty expense list should return 0, not throw error"
    },
    {
      "case": "Case-insensitive location lookup",
      "handling": "Normalize to uppercase: 'nyc', 'NYC', 'Nyc' all match",
      "gotcha": "Store and lookup with consistent case normalization"
    }
  ],
  "test_cases": [
    {
      "name": "Basic NYC example from problem",
      "input": "NYC trip, $1200 hotel (3n), $400 meals (4d)",
      "expected": "1250.0",
      "explanation": "Hotel: $1050, Meals: $200"
    },
    {
      "name": "Under all limits",
      "input": "Austin trip, $300 hotel (2n @ $150), $60 meals (3d @ $20)",
      "expected": "330.0",
      "explanation": "Hotel: $300 (under $180 limit), Meals: $10\u00d73=$30 (50% of $20 under $60 limit)"
    },
    {
      "name": "Unknown location uses defaults",
      "input": "Chicago trip, $250 hotel (1n), $80 meals (2d)",
      "expected": "240.0",
      "explanation": "Hotel: min($250, $200)=$200, Meals: min($40\u00d70.5, $50)\u00d72=$40"
    },
    {
      "name": "Meal limit caps reimbursement",
      "input": "Austin trip (meal limit $60), $200/day meals for 2 days",
      "expected": "120.0",
      "explanation": "$200\u00d70.5=$100 > $60 limit, so $60\u00d72=$120"
    },
    {
      "name": "Trip with flight and transport",
      "input": "NYC trip, $800 flight, $50 transport",
      "expected": "850.0",
      "explanation": "Flight/transport use default policies, not affected by location per-diem"
    }
  ],
  "common_mistakes": [
    {
      "mistake": "Applying limit before 50% rate for meals",
      "why_wrong": "Incorrect formula: min(amount, limit) \u00d7 0.5 instead of min(amount \u00d7 0.5, limit)",
      "correct_approach": "Apply 50% rate first, THEN cap at daily limit",
      "code_example_wrong": "reimbursable = min(amount_per_day, limit) * 0.5",
      "code_example_correct": "reimbursable = min(amount_per_day * 0.5, limit)"
    },
    {
      "mistake": "Calculating nights wrong for hotel",
      "why_wrong": "Using days instead of nights: Mar 15-18 is 4 days but only 3 nights",
      "correct_approach": "nights = (end_date - start_date).days, NOT plus 1",
      "code_example_wrong": "int nights = trip.getDays(); // 4",
      "code_example_correct": "int nights = trip.getNights(); // 3"
    },
    {
      "mistake": "Not normalizing location for lookup",
      "why_wrong": "setLocationPerDiem(\"NYC\") won't match trip location \"nyc\"",
      "correct_approach": "Normalize both storage and lookup keys to uppercase",
      "code_example_wrong": "perDiems.put(location, config);",
      "code_example_correct": "perDiems.put(location.toUpperCase(), config);"
    },
    {
      "mistake": "Hardcoding NYC limits in strategy",
      "why_wrong": "Violates Open-Closed Principle, can't add new locations",
      "correct_approach": "Pass LocationPerDiem as parameter to strategy.calculate()",
      "code_example_wrong": "BigDecimal limit = new BigDecimal(\"350\"); // NYC hardcoded",
      "code_example_correct": "BigDecimal limit = perDiem != null ? perDiem.getHotelLimit() : DEFAULT;"
    }
  ],
  "interview_tips": {
    "how_to_present": "Start by drawing the data model (Trip, LocationPerDiem, Expense). Explain how per-diem flows from Manager \u2192 Strategy. Walk through the NYC example calculation step by step before coding.",
    "what_to_mention": [
      "Dependency injection: per-diem passed TO strategies, not looked up BY strategies",
      "Days vs nights distinction for hotel vs meal calculations",
      "Graceful fallback to default limits for unconfigured locations",
      "Order of operations for meals: 50% THEN cap",
      "Using Decimal/BigDecimal for financial precision"
    ],
    "time_allocation": "3 min: Understand requirements and clarify meal formula. 5 min: Design data model and strategy modifications. 7 min: Implement and test with NYC example.",
    "if_stuck": [
      "Draw out the NYC example calculation step by step on paper",
      "Start with the LocationPerDiem class - it's the simplest new component",
      "Ask: 'Should meal limit be applied before or after 50%?' (Answer: after)",
      "Remember: Trip calculates days/nights from dates, strategies use those values"
    ]
  },
  "connection_to_next_part": "Part 4 might introduce **expense approval workflows** where certain expenses require manager approval before reimbursement, or **receipt verification** requirements where expenses over a threshold need attached receipts. The Trip entity provides a natural grouping for batch approvals.",
  "generated_at": "2026-01-14T15:19:22.294808",
  "_meta": {
    "problem_id": "travel_expense_calculation",
    "part_number": 3,
    "model": "claude-opus-4-5-20251101"
  }
}